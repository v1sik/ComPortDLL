unit ComPortLib;

interface

uses
  Winapi.Windows, Vcl.Forms, Cport, System.SysUtils;

procedure ShowComPortSettings(ParentHandle: HWND); stdcall;
procedure OpenComPort();
procedure CloseComPort();
procedure SetDataMessage(const Msg: string); stdcall;
implementation

uses
  PortSettingsForm; // ‘орма, которую мы показываем

  var cpComPort: TComPort;

procedure InitComPort; stdcall;
begin
  if not Assigned(cpComPort) then
  begin
    cpComPort := TComPort.Create(nil);
    cpComPort.Port := 'COM1';
    cpComPort.BaudRate := br9600;
    // другие начальные значени€
  end;
end;

procedure OpenComPort();
begin
  if not Assigned(cpComPort) then
    Exit;
  try
    if not cpComPort.Connected then
      cpComPort.Open;
  except
    on E: Exception do
    begin
      // «десь можно логировать или показать ошибку, например:
      // ShowMessage('Ќе удалось открыть COM-порт: ' + E.Message);
      raise; // или убрать, если не хочешь прерывать поток
    end;
  end;
end;

procedure CloseComPort();
begin
  if not Assigned(cpComPort) then
    Exit;
  try
    if cpComPort.Connected then
      cpComPort.Close;
  except
    on E: Exception do
    begin
      // Ћогирование/обработка ошибки закрыти€
      raise;
    end;
  end;
end;

procedure SetNumComPort(ComPort: TComPort; const PortName: string);
begin
  if Assigned(ComPort) then
    ComPort.Port := PortName;
end;

procedure SetBaudComPort(Baud: TBaudRate);
begin
  if Assigned(cpComPort) then
    cpComPort.BaudRate := Baud;
end;

procedure SetDataMessage(const Msg: string); stdcall;
begin
  if Assigned(cpComPort) and cpComPort.Connected then
  begin
    try
      cpComPort.WriteStr(Msg);
    except
      on E: Exception do
        ; // можно логировать: E.Message
    end;
  end;
end;
procedure ShowComPortSettings(ParentHandle: HWND); stdcall;
begin
  if not Assigned(cpComPort) then
    InitComPort; // создаст один раз

  Application.Handle := ParentHandle;

  with TFormComSettings.Create(nil) do
  try
    SetPort(cpComPort); // <-- вот сюда передаЄшь
    ShowModal; // внутри при изменении порта применитс€ к cpComPort
  finally
    Free;
  end;
end;
end.

